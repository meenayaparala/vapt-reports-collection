
# 6. Server-Side Template Injection in Java Template (JSP/Java Expression Language)

## 2. CVSS Score

**CVSS v3.1 Base Score:** 7.5 (High)
**CWE-94:** Improper Control of Generation of Code ('Code Injection')

---

## 3. OWASP Top 10 Reference

* **A03:2021 – Injection**

---

## 4. Description of Vulnerability

The application uses Java Server Pages (JSP) or Java Expression Language (EL) to render product descriptions. The product object is exposed in the template, and it is possible to access Java class methods via method chaining on this object. This allows arbitrary file reading from the server by chaining methods to read sensitive files such as `/home/carlos/my_password.txt`. This is a severe Server-Side Template Injection (SSTI) vulnerability enabling disclosure of sensitive server-side information.

---

## 5. Detailed Explanation of What We Performed

* Logged into the application and navigated to edit one of the product description templates.
* Used the product object to test method execution by injecting `${product.getClass()}` to confirm the Java class object is accessible.
* Explored the Java documentation and used method chaining to call `getProtectionDomain()`, `getCodeSource()`, `getLocation()`, and then converted the location to URI and resolved the path to the file `/home/carlos/my_password.txt`.
* Used `toURL().openStream().readAllBytes()` chained with `?join(" ")` in the template expression to read the file contents as bytes and convert them to a readable string.
* Saved the template and observed the file contents rendered as decimal ASCII values on the page.
* Converted the decimal ASCII codes to ASCII characters to obtain the password string.
* Submitted the extracted password to solve the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Access Product Description Template

1. Log into the application.
2. Navigate to the product description template editor.

---

### Step 2: Confirm Template Injection and Access to Product Object

3. Inject `${product.getClass()}` into the template.
4. Save and confirm the output shows the Java class of the product object.

---

### Step 3: Construct Payload to Read File

5. Inject the following payload replacing the file path as needed:

```
${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```

6. Save the template.
7. Observe the output showing the contents of the file as decimal ASCII code points.

---

### Step 4: Decode and Submit Solution

8. Convert the decimal ASCII output to readable ASCII text (the password).
9. Copy the password string.
10. Click "Submit solution" and enter the password to solve the lab.

---

## 7. Impact of the Vulnerability

* Disclosure of sensitive files from the server filesystem.
* Potential for further exploitation based on leaked credentials or configuration.
* Complete compromise of confidentiality and potentially integrity of the system.

---

## 8. Recommendations and Mitigations

* Avoid exposing Java objects directly to templates without strict input validation and sanitization.
* Disable method chaining or restrict available methods in template contexts.
* Use strict sandboxing of template execution environments.
* Implement proper access controls on sensitive files.
* Monitor and audit template editing functionalities carefully.

---

## 9. References

* [Java Reflection and Method Chaining](https://docs.oracle.com/javase/tutorial/reflect/)
* [Java Security - ProtectionDomain](https://docs.oracle.com/javase/8/docs/api/java/security/ProtectionDomain.html)
* [OWASP Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html)
* [PortSwigger Labs – SSTI](https://portswigger.net/web-security/template-injection)

