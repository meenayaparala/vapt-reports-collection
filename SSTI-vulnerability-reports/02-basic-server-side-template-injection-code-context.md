
# 2. Server-Side Template Injection via blog-post-author-display Parameter (Tornado)

## 2. CVSS Score

**CVSS v3.1 Base Score: 7.1 (High)**
**CWE-94: Improper Control of Generation of Code ('Code Injection')**

---

## 3. OWASP Top 10 Reference

* **A03:2021 – Injection**

---

## 4. Description of Vulnerability

The application allows injection of arbitrary Tornado template syntax via the `blog-post-author-display` parameter on the "My account" page. The parameter's value is used unsafely in template rendering, permitting an attacker to execute arbitrary Python code server-side. This enables OS command execution, leading to severe security consequences such as file deletion or remote code execution.

---

## 5. Detailed Explanation of What We Performed

* Logged in and posted a comment on a blog post.
* Observed that the `blog-post-author-display` parameter controls how the author name appears.
* Tested template injection by appending `}} {{7*7}}` to the parameter, which rendered `49` on the page.
* Identified Tornado template syntax for arbitrary Python execution: `{% somePython %}`.
* Crafted payload to import the `os` module and execute system command to delete Carlos's file.
* Injected the payload via Burp Repeater in the `blog-post-author-display` parameter, URL-encoded.
* Reloaded the comment page to execute the payload and delete the file, solving the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Intercept and Analyze Parameter

1. Log in and post a comment on a blog post.
2. On "My account," change the `blog-post-author-display` setting.
3. In Burp Proxy, find the POST `/my-account/change-blog-post-author-display` request.
4. Send it to Burp Repeater.

---

### Step 2: Test SSTI Injection

5. Modify the parameter value to:

```
user.name}} {{7*7}}
```

6. Reload the page containing the comment.
7. Confirm that the number `49` is rendered next to the username, confirming SSTI.

---

### Step 3: Prepare and Inject OS Command Execution Payload

8. From Tornado docs, use:

```
{% import os %}
{{os.system('rm /home/carlos/morale.txt')}}
```

9. Break out of the expression and inject the payload, URL-encoded as:

```
user.name}}{%25+import+os+%25}{{os.system('rm%20/home/carlos/morale.txt')}}
```

10. Update the `blog-post-author-display` parameter in Burp Repeater with this value.
11. Send the request.

---

### Step 4: Execute and Solve Lab

12. Reload the blog page with the comment.
13. The payload executes, deleting Carlos's morale file.
14. Lab is solved.

---

## 7. Impact of the Vulnerability

* Allows arbitrary Python code execution on the server.
* Enables OS command execution with the privileges of the web server.
* Can lead to file deletion, data theft, or full server takeover.
* Represents a critical security risk.

---

## 8. Recommendations and Mitigations

* Avoid rendering unsanitized user input directly in templates.
* Use strict input validation and escaping on template parameters.
* Employ sandboxed template engines that restrict code execution.
* Run applications with least privilege to minimize impact.
* Monitor and alert on suspicious template evaluations.

---

## 9. References

* [Tornado Template Documentation](https://www.tornadoweb.org/en/stable/templates.html)
* [Python os.system() Documentation](https://docs.python.org/3/library/os.html#os.system)
* [OWASP Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html)
* [PortSwigger Labs – SSTI](https://portswigger.net/web-security/template-injection)

