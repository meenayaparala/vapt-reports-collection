
# 3. Server-Side Template Injection via Product Description Template (Freemarker)

## 2. CVSS Score

**CVSS v3.1 Base Score: 8.1 (High)**
**CWE-94: Improper Control of Generation of Code ('Code Injection')**

---

## 3. OWASP Top 10 Reference

* **A03:2021 – Injection**

---

## 4. Description of Vulnerability

The product description template functionality uses the Freemarker template engine, which renders expressions enclosed in `${...}`. The application allows editing these templates, enabling injection of arbitrary Freemarker expressions. Due to insecure handling, an attacker can exploit the `new()` built-in function to instantiate the `freemarker.template.utility.Execute` class, allowing execution of arbitrary OS commands on the server, such as deleting files.

---

## 5. Detailed Explanation of What We Performed

* Logged in and edited a product description template.
* Entered a non-existent variable `${foobar}` to confirm Freemarker usage via the error message.
* Reviewed Freemarker documentation, noting the security risk of the `new()` built-in.
* Found that `freemarker.template.utility.Execute` class can execute shell commands.
* Crafted an exploit payload:

```
<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("rm /home/carlos/morale.txt") }
```

* Removed previous invalid expressions and inserted the payload.
* Saved the template.
* Visited the product page to execute the payload and solve the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Confirm Template Engine and Vulnerability

1. Log in and edit a product description template.
2. Replace or add `${foobar}` in the template.
3. Save and observe the Freemarker error message confirming the engine in use.

---

### Step 2: Research Exploit and Prepare Payload

4. Study Freemarker docs, focusing on `new()` built-in and the `freemarker.template.utility.Execute` class.
5. Craft payload to instantiate `Execute` and run OS commands:

```
<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("rm /home/carlos/morale.txt") }
```

---

### Step 3: Inject and Execute Payload

6. Remove the `${foobar}` expression from the template.
7. Insert the crafted payload.
8. Save the template.
9. Load the product page to trigger the payload.

---

### Step 4: Solve Lab

10. The command deletes Carlos’s morale file.
11. Lab is solved.

---

## 7. Impact of the Vulnerability

* Allows arbitrary OS command execution via template injection.
* Can lead to file deletion, data leakage, server compromise.
* Severe risk to application and host security.

---

## 8. Recommendations and Mitigations

* Disable user editing of template code or restrict to safe subsets.
* Sanitize and validate all template inputs.
* Avoid enabling dangerous built-ins like `new()`.
* Employ least privilege for the application user.
* Use security policies to restrict template capabilities.

---

## 9. References

* [Freemarker Documentation – Built-ins](https://freemarker.apache.org/docs/ref_builtins.html#ref_builtin_new)
* [Freemarker FAQ – Security Implications](https://freemarker.apache.org/docs/pgui_misc_faq.html#faq_new)
* [OWASP Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html)
* [PortSwigger Labs – SSTI](https://portswigger.net/web-security/template-injection)

