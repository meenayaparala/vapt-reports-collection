
# 1. Exploiting XInclude to Retrieve Files

## 2. CVSS Score

**CVSS v3.1 Base Score: 8.0 (High)**
**CWE-611: Improper Restriction of XML External Entity Reference (‘XXE’)**

## 3. OWASP Top 10 Reference

* **A05:2021 – Security Misconfiguration**
* **A03:2021 – Injection**

---

## 4. Description of Vulnerability

In this lab, we explore an **XML External Entity (XXE)** vulnerability that allows an attacker to **exfiltrate sensitive files** from the server by exploiting **XInclude**. The XInclude feature of XML allows the inclusion of external XML documents into an XML document, but when improperly configured, it can be used to reference local system files and reveal sensitive information such as the contents of `/etc/passwd`.

This vulnerability arises when the application embeds user input inside an XML document that is subsequently parsed, and **XInclude** is enabled but not properly restricted.

---

## 5. Detailed Explanation of What We Performed

In this lab, we leveraged the **XInclude** feature to include the contents of the `/etc/passwd` file by injecting an **XInclude** statement into the **productId** parameter. This allowed us to bypass the server's XML parsing limitations and retrieve the contents of the file as part of the application's response.

---

## 6. Step-by-Step Procedure

### Step 1: Intercept the POST Request

1. Visit the **product page** on the application, then click the **"Check stock"** button.
2. Intercept the resulting **POST request** using **Burp Suite**'s **Proxy**.

### Step 2: Modify the ProductId Parameter

3. In the intercepted request, modify the `productId` parameter to inject an **XInclude** statement:

```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/>
</foo>
```

Here, we are using the **`<xi:include>`** tag to include the contents of the **`/etc/passwd`** file.

4. Forward the modified request to the server.

### Step 3: Observe the Response

5. The server will parse the modified XML, and the response will contain the contents of the **`/etc/passwd`** file.

---

## 7. Impact of the Vulnerability

* **Sensitive File Exposure**: By exploiting the XInclude feature, an attacker can access and exfiltrate sensitive files like `/etc/passwd`. The contents of this file may contain user credentials and other sensitive system information.
* **Information Disclosure**: Exposure of system files can give attackers valuable information for further exploitation, including potential attacks like **privilege escalation** or **gaining system control**.
* **Exploitation Chain**: Access to files like `/etc/passwd` may lead to further attacks such as **LFI (Local File Inclusion)**, **RCE (Remote Code Execution)**, or **credential harvesting**.

---

## 8. Recommendations and Mitigations

* **Disable XInclude**: If XInclude functionality is not needed, ensure it is disabled in the XML parser.
* **Restrict File Access**: Implement restrictions to prevent the inclusion of sensitive local files such as `/etc/passwd`. Ensure the application cannot access sensitive directories.
* **Use Secure XML Parsers**: Employ modern XML parsers that are secure by default, such as **defusedxml** for Python, which prevents XXE and XInclude attacks.
* **Validate Input**: Always validate and sanitize any user input that is used in XML documents, particularly when user input can affect the structure or content of the XML.

---

## 9. References

* [OWASP XXE Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
* [PortSwigger XInclude Guide](https://portswigger.net/web-security/xxe)

---

## 10. Proof of Concept

### Malicious Payload:

```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/>
</foo>
```

### Intercepted XML Request:

```xml
<stockCheck>
  <productId>
    <foo xmlns:xi="http://www.w3.org/2001/XInclude">
      <xi:include parse="text" href="file:///etc/passwd"/>
    </foo>
  </productId>
  <storeId>1</storeId>
</stockCheck>
```

### Server Response:

The response should contain the contents of the `/etc/passwd` file, demonstrating the successful exploitation of the **XInclude** vulnerability.
