
# 14. 2FA Brute Force via Session Handling Macro in Burp

## 2. CVSS Score

**CVSS v3.1 Base Score: 7.5 (High)**
**CWE-287: Improper Authentication**
**CWE-307: Improper Restriction of Excessive Authentication Attempts**

---

## 3. OWASP Top 10 Reference

* **A07:2021 – Identification and Authentication Failures**
* **A05:2021 – Security Misconfiguration**

---

## 4. Description of Vulnerability

The 2-Factor Authentication (2FA) mechanism allows an attacker to brute force the 4-digit MFA code due to insufficient rate limiting and session management. Additionally, after two incorrect attempts, the user is logged out and must log back in, which can be automated by Burp’s session handling macros. This allows automated brute forcing of the 2FA code by handling login sessions automatically before each request.

---

## 5. Detailed Explanation of What We Performed

* Logged in as Carlos and observed the 2FA verification process.
* Noticed that two incorrect MFA attempts cause logout.
* Configured Burp Session Handling Rules to automatically run a macro that logs in before each Intruder request.
* Created a macro recording the GET /login, POST /login, and GET /login2 requests to handle login and reach 2FA input page.
* Tested the macro to ensure it successfully reached the 2FA page.
* Sent the POST /login2 request to Burp Intruder.
* Added payload position to the `mfa-code` parameter.
* Configured payloads as all 4-digit numbers from 0000 to 9999.
* Set resource pool concurrency to 1 to avoid session issues.
* Ran the Intruder attack until a request returned a 302 status code (success).
* Loaded the successful response in the browser and accessed the My Account page to solve the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Investigate and Configure Session Handling

1. Log in manually as Carlos and observe the 2FA verification process.
2. Open Burp **Settings** > **Sessions** > **Session Handling Rules**.
3. Click **Add** to create a new session handling rule.
4. In the **Scope** tab, select **Include all URLs**.
5. In the **Details** tab, under **Rule Actions**, click **Add** > **Run a macro**.
6. Click **Add** to record a macro.
7. Select these three requests in order:

   * `GET /login`
   * `POST /login`
   * `GET /login2`
8. Click **OK** and then **Test macro**.
9. Confirm the final response contains the 2FA code input page.
10. Close dialogs to save the macro and session handling rule.

---

### Step 2: Prepare Intruder Attack

11. Intercept or send the `POST /login2` request to Burp Intruder.
12. Highlight and add a payload position on the `mfa-code` parameter.

---

### Step 3: Configure Payload and Resource Pool

13. Set payload type to **Numbers**.
14. Set the range from `0` to `9999`, step `1`.
15. Set minimum and maximum integer digits to `4` (to pad with leading zeros).
16. Set maximum fraction digits to `0`.
17. Open **Resource pool** panel.
18. Create or assign the attack to a resource pool with **Maximum concurrent requests** set to `1` (to avoid session conflicts).

---

### Step 4: Start Attack and Analyze Results

19. Start the Intruder attack.
20. Monitor responses until one returns **HTTP 302**, indicating successful 2FA code.
21. Right-click the successful request and choose **Show response in browser**.
22. Copy the URL and load it in a normal browser tab.
23. Access the **My account** page to confirm login and solve the lab.

---

## 7. Impact of the Vulnerability

* Allows attackers to brute force the 2FA code despite logout enforcement after failed attempts.
* The use of Burp’s session handling macros automates repeated login steps, bypassing logout restrictions.
* Compromises the additional security layer 2FA is supposed to provide, leading to unauthorized access.
* Facilitates account takeover and potential further exploitation.

---

## 8. Recommendations and Mitigations

* Implement rate limiting on the 2FA verification endpoint to restrict attempts per time window.
* Introduce account lockout or cooldown after multiple failed 2FA attempts.
* Enforce stronger 2FA mechanisms (longer codes, time-based tokens).
* Harden session management to prevent automated login attempts.
* Log and alert on abnormal 2FA failures and brute force attempts.

---

## 9. References

* [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
* [PortSwigger Labs - Bypassing 2FA with Session Handling Macros](https://portswigger.net/web-security/multi-factor-authentication/bypassing-2fa)
* [Burp Suite Documentation: Session Handling Rules](https://portswigger.net/burp/documentation/desktop/tools/session-handling)

