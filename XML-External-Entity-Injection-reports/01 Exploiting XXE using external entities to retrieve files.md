
# 1. Exploiting XXE Using External Entities to Retrieve Files

## 2. CVSS Score

**CVSS v3.1 Base Score: 7.5 (High)**
**CWE-611: Improper Restriction of XML External Entity Reference (â€˜XXEâ€™)**

## 3. OWASP Top 10 Reference

* **A05:2021 â€“ Security Misconfiguration**
* **A04:2021 â€“ Insecure Design**

## 4. Description of Vulnerability

This lab demonstrates an **XML External Entity (XXE) Injection** vulnerability. The application processes user-supplied XML in a way that allows attackers to define and reference external entities. This enables the retrieval of arbitrary files from the server.

In this lab, the attacker leverages an XXE payload to retrieve the contents of the sensitive system file: `/etc/passwd`. This is possible because the server-side XML parser is insecurely configured and resolves external entities without proper validation or restrictions.

## 5. Detailed Explanation of What We Performed

We used **Burp Suite** to intercept the POST request made when using the "Check stock" feature of the application. By injecting a malicious **DOCTYPE** declaration that defines an external entity pointing to `/etc/passwd`, we were able to retrieve and display the contents of the file in the application's response.

---

### 6.Step-by-Step Procedure

ðŸ”¹ **Step 1: Visit the Target and Intercept the Request**

* Navigate to any product page on the lab website.
* Click the **"Check stock"** button.
* Intercept the resulting **POST** request using **Burp Suite Proxy**.

ðŸ”¹ **Step 2: Inject External Entity Definition**

In Burp Suite, modify the intercepted XML payload to include a malicious `DOCTYPE` declaration that defines an external entity named `xxe`. Example payload:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

ðŸ”¹ **Step 3: Forward the Request and Observe the Response**

* Forward the modified request to the server.
* The response will now include:
  `"Invalid product ID: "` followed by the contents of the `/etc/passwd` file, proving that the XXE injection succeeded.

---

## 7. Impact of the Vulnerability

* **Sensitive File Exposure**: Attackers can access local files on the server, potentially leading to further compromise.
* **Information Disclosure**: The contents of files like `/etc/passwd` can help in privilege escalation or identifying system configurations.
* **Foundation for Deeper Attacks**: Access to sensitive files can lead to chaining of attacks such as credential theft, LFI, or even RCE depending on server context.

---

## 8. Recommendations and Mitigations

* **Disable DTDs** (External Entities): Configure XML parsers to disallow `DOCTYPE` declarations entirely, if not needed.
* **Use Secure Parsers**: Employ modern XML parsers with secure defaults (e.g., defusedxml for Python).
* **Input Validation**: Ensure XML payloads are validated and sanitized before processing.
* **Isolate File Systems**: Limit the XML processorâ€™s ability to access sensitive files by using containerized environments and proper permissions.

---

## 9. References

* [OWASP XXE Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
* [PortSwigger XXE Guide](https://portswigger.net/web-security/xxe)

---

## 10. Proof of Concept

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

