
# 05. Username Enumeration via Response Timing and IP-based Brute Force Bypass

## 2. CVSS Score

**CVSS v3.1 Base Score: 7.0 (High)**
**CWE-204: Response Discrepancy Information Exposure**

---

## 3. OWASP Top 10 Reference

* **A07:2021 – Identification and Authentication Failures**
* **A05:2021 – Security Misconfiguration**

---

## 4. Description of Vulnerability

This lab involves **username enumeration via timing differences** in login responses and bypassing IP-based brute force protection by **spoofing the X-Forwarded-For header**.

The application slows response time when a valid username is submitted with an incorrect password, allowing attackers to identify valid usernames by measuring response delays. Also, IP-based brute-force protections can be circumvented by spoofing IP addresses using the `X-Forwarded-For` header.

---

## 5. Detailed Explanation of What We Performed

We first confirmed that the IP is blocked after multiple invalid login attempts. Then, we identified that the server uses the `X-Forwarded-For` header for IP tracking, enabling us to spoof different IP addresses to bypass this restriction.

Using Burp Intruder with a **Pitchfork attack**, we varied the `X-Forwarded-For` header value (numeric range 1-100) alongside different usernames and a long static password.

By examining the **response times** in the Intruder results, one username caused consistently longer responses, indicating it was valid.

Afterwards, we launched a password brute-force attack for this username using spoofed IPs in the `X-Forwarded-For` header. The login success was confirmed by a 302 HTTP response.

---

## 6. Step-by-Step Procedure

### Step 1: Test Login and Identify IP Blocking

1. Submit multiple invalid login requests via Burp Repeater.
2. Notice IP block after several invalid attempts.

---

### Step 2: Identify and Spoof `X-Forwarded-For` Header

3. Add the `X-Forwarded-For` header to requests and confirm it is supported.
4. Spoof different IPs via this header to bypass IP-based blocking.

---

### Step 3: Use Burp Intruder with Pitchfork Attack

5. Send a valid login request with long password (about 100 characters) to Intruder.
6. Select **Pitchfork** attack type.
7. Add payload positions for `X-Forwarded-For` header and `username`.
8. For `X-Forwarded-For`, use **Numbers payload type** with range 1–100.
9. For `username`, add the list of candidate usernames.
10. Start the attack.

---

### Step 4: Analyze Response Times

11. In the Intruder results, enable columns: **Response received** and **Response completed**.
12. Identify a username with consistently **longer response times**, confirming it is valid.

---

### Step 5: Brute-force Password with IP Spoofing

13. Create a new Intruder attack on the same request.
14. Add payload positions for `X-Forwarded-For` header, fixed valid username, and `password`.
15. For IP spoofing, use the same numbers payload (1-100).
16. For password, add the candidate password list.
17. Start the attack.

---

### Step 6: Identify Successful Login and Solve Lab

18. Look for a request with **HTTP 302** status, indicating success.
19. Note the corresponding password.
20. Log in using the identified username and password.
21. Access the user account page to solve the lab.

---

## 7. Impact of the Vulnerability

* Enables attackers to **enumerate valid usernames** using timing attacks.
* Allows attackers to **bypass IP-based brute-force protection** via IP spoofing.
* Increases risk of **credential stuffing and brute-force account compromise**.

---

## 8. Recommendations and Mitigations

* Use **constant-time responses** to prevent timing-based user enumeration.
* Implement **stronger brute-force protections** that do not rely solely on IP.
* Use **multi-factor authentication** to limit brute-force impact.
* Disable or carefully validate headers like `X-Forwarded-For` if not required.

---

## 9. References

* [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
* [PortSwigger Lab: Username Enumeration via Timing](https://portswigger.net/web-security/authentication/password-based/lab-username-enumeration-via-response-timing)

---

## 10. Proof of Concept

### Pitchfork Attack Payload for IP Spoofing and Username Enumeration:

```http
POST /login HTTP/1.1
X-Forwarded-For: §1§
Content-Type: application/x-www-form-urlencoded
...

username=§username§&password=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
```

### Password Brute-force Payload:

```http
POST /login HTTP/1.1
X-Forwarded-For: §1§
Content-Type: application/x-www-form-urlencoded
...

username=valid-user&password=§password§
```

