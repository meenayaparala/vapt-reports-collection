
# 7. Server-Side Template Injection via Avatar Manipulation and File Operations

## 2. CVSS Score

**CVSS v3.1 Base Score:** 8.1 (High)
**CWE-94:** Improper Control of Generation of Code ('Code Injection')

---

## 3. OWASP Top 10 Reference

* **A03:2021 – Injection**

---

## 4. Description of Vulnerability

The application’s “My account” page allows users to set a preferred name vulnerable to server-side template injection (SSTI). The user object exposed in the template has a `setAvatar()` method that accepts file paths. This allows an attacker to set arbitrary server-side files as avatars. The avatar content is then rendered using template logic, enabling arbitrary file read. Additionally, the presence of a `gdprDelete()` method on the user object can be invoked to delete sensitive files by combining it with SSTI. This leads to unauthorized disclosure and deletion of sensitive server files, causing serious security risks.

---

## 5. Detailed Explanation of What We Performed

* Logged in and posted a comment on a blog to track changes.
* Navigated to “My account” page and confirmed SSTI vulnerability in the preferred name field.
* Investigated avatar upload functionality: uploaded invalid images and noted error messages revealing the `user.setAvatar()` method and the file path `/home/carlos/User.php`.
* Uploaded a valid image as an avatar and viewed the blog comment page.
* Used Burp Suite Repeater to intercept the POST request changing preferred name and injected `user.setAvatar('/etc/passwd')`.
* Noted an error demanding an image MIME type as a second parameter; corrected injection to `user.setAvatar('/etc/passwd','image/jpg')`.
* Reloaded the comment page and confirmed `/etc/passwd` contents were rendered as avatar, proving arbitrary file read.
* Repeated the process to read `/home/carlos/User.php` using the same technique.
* Analyzed the PHP source and found the `gdprDelete()` method which deletes the user’s avatar file.
* Set the target file `/home/carlos/.ssh/id_rsa` as the avatar to mark it for deletion.
* Invoked `user.gdprDelete()` to delete the private SSH key file on the server.
* Viewed the comment page to trigger template execution and file deletion, thereby solving the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Setup and Confirm SSTI

1. Log into the application and post a blog comment for testing.
2. Navigate to “My account” page and note the preferred name input vulnerable to SSTI.

---

### Step 2: Explore Avatar Functionality

3. Upload an invalid image file as avatar.
4. Observe error message referencing `user.setAvatar()` and `/home/carlos/User.php`.

---

### Step 3: Arbitrary File Read via Avatar

5. Upload a valid image to reset avatar.
6. Intercept the POST request for changing preferred name in Burp Repeater.
7. Modify the `blog-post-author-display` parameter to:

   ```
   user.setAvatar('/etc/passwd')
   ```
8. Send the request; observe error requiring MIME type as second argument.
9. Update to:

   ```
   user.setAvatar('/etc/passwd','image/jpg')
   ```
10. Reload the comment page to confirm `/etc/passwd` file contents are displayed.

---

### Step 4: Read Sensitive PHP File

11. Repeat step 7 and 9 with:

    ```
    user.setAvatar('/home/carlos/User.php','image/jpg')
    ```
12. Inspect the revealed PHP source code, noting `gdprDelete()` function.

---

### Step 5: Delete Sensitive File Using gdprDelete()

13. Set avatar to target file for deletion:

    ```
    user.setAvatar('/home/carlos/.ssh/id_rsa','image/jpg')
    ```
14. Invoke the delete method in the template:

    ```
    user.gdprDelete()
    ```
15. Reload the comment page to trigger file deletion.

---

### Step 6: Submit Solution

16. Confirm deletion or solution completion.
17. Click "Submit solution" to solve the lab.

---

## 7. Impact of the Vulnerability

* Arbitrary file read on the server, leaking sensitive files like `/etc/passwd` and source code.
* Arbitrary file deletion, including critical files like SSH private keys, causing denial of service or further compromise.
* Complete loss of confidentiality and potential denial of service.

---

## 8. Recommendations and Mitigations

* Sanitize and validate all user inputs, especially those rendered in templates.
* Restrict file path inputs and avoid exposing file system operations via templates.
* Implement strong access controls on sensitive files and functions.
* Disable dangerous template features or sandbox the template execution environment.
* Log and monitor template editing and file manipulation activities closely.

---

## 9. References

* [PHP Object Injection and SSTI](https://portswigger.net/web-security/template-injection)
* [OWASP Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html)
* [Burp Suite Official Documentation](https://portswigger.net/burp/documentation)
* [Server-Side Template Injection in Web Applications](https://owasp.org/www-community/attacks/Server_Side_Template_Injection)

